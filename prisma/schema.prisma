generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Attachment {
  id        Int      @id @default(autoincrement())
  guid      String   @unique
  filename  String
  fileData  Bytes
  createdAt DateTime @default(now())
}

model Category {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  courses          Course[]
  educationalPaths EducationalPath[]
}

model Course {
  id                     Int                     @id @default(autoincrement())
  title                  String
  description            String?
  imageId                String?
  categoryId             Int?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  authorId               Int
  schoolId               Int?                    // Szkoła, do której należy ten kurs (właściciel majątkowy)
  mode                   Int                     @default(0)
  state                  Int                     @default(0)
  author                 User?                   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  school                 School?                 @relation("SchoolCourses", fields: [schoolId], references: [id], onDelete: Cascade)
  category               Category?               @relation(fields: [categoryId], references: [id])
  price                  CoursePrice?
  modules                Module[]
  userCourses            UserCourse[]
  educationalPathCourses EducationalPathCourse[]
  communicationLinks     CourseCommunication[]

  @@index([authorId])
  @@index([categoryId])
  @@index([schoolId])
}

model CoursePrice {
  id              Int            @id @default(autoincrement())
  amount          Decimal        @default(0) @db.Decimal(10, 2)
  currency        String         @default("PLN")
  isRecurring     Boolean        @default(false)
  interval        PriceInterval?
  courseId        Int            @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now())
  trialPeriodDays Int?
  trialPeriodEnd  DateTime?      @db.Timestamp(6)
  trialPeriodType String?        @db.VarChar(255)
  vatRate         Decimal        @default(23) @db.Decimal(5, 2)
  course          Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model CoursePromoCode {
  id          Int @id @default(autoincrement())
  courseId    Int
  promoCodeId Int

  @@unique([courseId, promoCodeId], map: "CoursePromoCode_unique")
}

model EducationalPath {
  id          Int                       @id @default(autoincrement())
  title       String                    @db.VarChar(255)
  description String?
  createdAt   DateTime                  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime                  @default(now()) @db.Timestamp(6)
  imageId     String?                   @db.VarChar(255)
  mode        Int                       @default(0)
  state       Int                       @default(0)
  authorId    Int?
  schoolId    Int?                      // Szkoła, do której należy ta ścieżka (właściciel majątkowy)
  categoryId  Int?
  author      User?                     @relation(fields: [authorId], references: [id])
  school      School?                   @relation("SchoolEducationalPaths", fields: [schoolId], references: [id], onDelete: Cascade)
  category    Category?                 @relation(fields: [categoryId], references: [id])
  courses     EducationalPathCourse[]
  price       EducationalPathPrice?
  userPaths   UserEducationalPath[]
  purchases   EducationalPathPurchase[]

  @@index([authorId])
  @@index([categoryId])
  @@index([schoolId])
}

model EducationalPathCourse {
  id                Int             @id @default(autoincrement())
  educationalPathId Int
  courseId          Int
  position          Int
  educationalPath   EducationalPath @relation(fields: [educationalPathId], references: [id], onDelete: Cascade)
  course            Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([educationalPathId, courseId], map: "EducationalPathCourse_unique")
  @@index([courseId])
  @@index([educationalPathId])
}

model EducationalPathPrice {
  id                Int             @id @default(autoincrement())
  amount            Decimal         @default(0) @db.Decimal(10, 2)
  currency          String          @default("PLN") @db.VarChar(10)
  isRecurring       Boolean         @default(false)
  interval          String?         @db.VarChar(10)
  educationalPathId Int             @unique
  createdAt         DateTime        @default(now()) @db.Timestamp(6)
  updatedAt         DateTime        @default(now()) @db.Timestamp(6)
  trialPeriodDays   Int?
  trialPeriodEnd    DateTime?       @db.Timestamp(6)
  trialPeriodType   String?         @db.VarChar(10)
  vatRate           Decimal         @default(23) @db.Decimal(5, 2)
  educationalPath   EducationalPath @relation(fields: [educationalPathId], references: [id], onDelete: Cascade)
}

model EducationalPathPromoCode {
  id                Int @id @default(autoincrement())
  educationalPathId Int
  promoCodeId       Int

  @@unique([educationalPathId, promoCodeId], map: "EducationalPathPromoCode_unique")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model EducationalPathPurchase {
  id                 Int             @id @default(autoincrement())
  userId             Int
  educationalPathId  Int
  purchaseDate       DateTime        @default(now()) @db.Timestamp(6)
  paymentId          String?         @db.VarChar(255)
  eventType          String?         @db.VarChar(100)
  amount             Decimal?        @db.Decimal(10, 2)
  currency           String?         @db.VarChar(10)
  paymentStatus      String?         @db.VarChar(50)
  paymentMethod      String?         @db.VarChar(100)
  subscriptionId     String?         @db.VarChar(255)
  isRecurring        Boolean         @default(false)
  subscriptionStatus String?         @db.VarChar(50)
  currentPeriodStart DateTime?       @db.Timestamp(6)
  currentPeriodEnd   DateTime?       @db.Timestamp(6)
  trialStart         DateTime?       @db.Timestamp(6)
  trialEnd           DateTime?       @db.Timestamp(6)
  customerEmail      String?         @db.VarChar(255)
  invoiceId          String?         @db.VarChar(255)
  receiptUrl         String?
  refundedAmount     Decimal?        @db.Decimal(10, 2)
  refundReason       String?         @db.VarChar(255)
  metadata           Json?
  stripeCustomerId   String?         @db.VarChar(255)
  createdAt          DateTime        @default(now()) @db.Timestamp(6)
  updatedAt          DateTime        @default(now()) @db.Timestamp(6)
  user               User            @relation(fields: [userId], references: [id])
  educationalPath    EducationalPath @relation(fields: [educationalPathId], references: [id])

  @@unique([userId, educationalPathId], map: "EducationalPathPurchase_unique")
  @@index([customerEmail])
  @@index([educationalPathId])
  @@index([paymentId])
  @@index([subscriptionId])
  @@index([userId])
}

model Module {
  id            Int             @id @default(autoincrement())
  position      Int
  courseId      Int?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  title         String
  state         Int             @default(0)
  publishedAt   DateTime?       // Data publikacji - lekcja zostanie opublikowana automatycznie w tej dacie
  course        Course?         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userModules   UserModule[]
  ModuleContent ModuleContent[]

  @@index([courseId])
  @@index([publishedAt]) // Index dla wydajnego wyszukiwania lekcji do publikacji
}

model ModuleContent {
  id        Int      @id @default(autoincrement())
  guid      String   @unique @default(uuid())
  data      Json
  createdAt DateTime @default(now())
  moduleId  Int?     @unique
  module    Module?  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
}

model PromoCode {
  id             Int       @id @default(autoincrement())
  code           String
  discount       Int
  description    String?
  expirationDate DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
}

model Role {
  id         Int          @id @default(autoincrement())
  name       String       @unique
  users      User[]
  UserCourse UserCourse[]
}

model StripeCustomer {
  id               Int      @id @default(autoincrement())
  stripeCustomerId String   @unique
  userId           Int      @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                       Int                       @id @default(autoincrement())
  providerId               String                    @unique
  email                    String                    @unique
  firstName                String?
  lastName                 String?
  displayName              String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime
  roleId                   Int                       @default(0)
  userCourses              UserCourse[]
  userModules              UserModule[]
  role                     Role?                    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  stripeCustomers          StripeCustomer[]
  courses                  Course[]
  educationalPaths         EducationalPath[]
  userEducationalPaths     UserEducationalPath[]
  educationalPathPurchases EducationalPathPurchase[]
  teacherPlatformSubscription TeacherPlatformSubscription?
  receivedNotifications    NotificationSentLog[]    @relation("NotificationRecipient")
  ownedSchools             School[]                 @relation("SchoolOwner")
  schoolMemberships        SchoolTeacher[]          @relation("TeacherInSchool")
  joinRequests             TeacherJoinRequest[]     @relation("RequestingTeacher")

  @@index([roleId])
}

model School {
  id                    Int                    @id @default(autoincrement())
  name                  String
  description           String?
  companyName           String
  taxId                 String
  ownerId               Int                    // Właściciel szkoły
  stripeAccountId       String?                // Szkoła ma jedno konto Stripe dla wszystkich nauczycieli
  stripeAccountStatus   String?                @default("pending")
  stripeOnboardingComplete Boolean              @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  owner                 User                   @relation("SchoolOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  teachers              SchoolTeacher[]        @relation("SchoolMembers")
  joinRequests          TeacherJoinRequest[]   @relation("SchoolRequests")
  courses               Course[]               @relation("SchoolCourses")
  educationalPaths      EducationalPath[]      @relation("SchoolEducationalPaths")
  notificationSchedules NotificationSchedule[] @relation("SchoolNotifications")

  @@index([ownerId])
  @@index([stripeAccountId])
  @@map("schools")
}

model SchoolTeacher {
  id        Int      @id @default(autoincrement())
  schoolId  Int
  teacherId Int
  addedAt   DateTime @default(now())

  school    School   @relation("SchoolMembers", fields: [schoolId], references: [id], onDelete: Cascade)
  teacher   User     @relation("TeacherInSchool", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([schoolId, teacherId])
  @@index([schoolId])
  @@index([teacherId])
  @@map("school_teachers")
}

model TeacherJoinRequest {
  id          Int       @id @default(autoincrement())
  teacherId   Int
  schoolId    Int
  status      String    @default("pending") // "pending", "accepted", "rejected"
  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  rejectionReason String?
  
  teacher     User      @relation("RequestingTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  school      School    @relation("SchoolRequests", fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([teacherId, schoolId])
  @@index([teacherId])
  @@index([schoolId])
  @@index([status])
  @@map("teacher_join_requests")
}

model UserCourse {
  id        Int                 @id @default(autoincrement())
  userId    Int
  courseId  Int
  createdAt DateTime            @default(now())
  updatedAt DateTime
  state     Int                 @default(0)
  roleId    Int?                @default(0)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  role      Role?               @relation(fields: [roleId], references: [id], onDelete: Cascade)
  purchase  UserCoursePurchase? @relation("UserCoursePurchaseToUserCourse")

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([roleId])
  @@index([userId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model UserCoursePurchase {
  id                 Int        @id @default(autoincrement())
  userCourseId       Int        @unique
  paymentId          String?
  purchaseDate       DateTime   @default(now())
  eventType          String?    @db.VarChar(100)
  amount             Decimal?   @db.Decimal(10, 2)
  currency           String?    @db.VarChar(10)
  paymentStatus      String?    @db.VarChar(50)
  paymentMethod      String?    @db.VarChar(100)
  subscriptionId     String?    @db.VarChar(255)
  isRecurring        Boolean    @default(false)
  subscriptionStatus String?    @db.VarChar(50)
  currentPeriodStart DateTime?  @db.Timestamp(6)
  currentPeriodEnd   DateTime?  @db.Timestamp(6)
  trialStart         DateTime?  @db.Timestamp(6)
  trialEnd           DateTime?  @db.Timestamp(6)
  customerEmail      String?    @db.VarChar(255)
  invoiceId          String?    @db.VarChar(255)
  receiptUrl         String?
  refundedAmount     Decimal?   @db.Decimal(10, 2)
  refundReason       String?    @db.VarChar(255)
  metadata           Json?
  stripeCustomerId   String?    @db.VarChar(255)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @default(now())
  userCourse         UserCourse @relation("UserCoursePurchaseToUserCourse", fields: [userCourseId], references: [id])

  @@index([customerEmail])
  @@index([paymentId])
  @@index([subscriptionId])
}

model UserEducationalPath {
  id                Int             @id @default(autoincrement())
  userId            Int
  educationalPathId Int
  createdAt         DateTime        @default(now()) @db.Timestamp(6)
  updatedAt         DateTime        @db.Timestamp(6)
  state             Int             @default(0)
  roleId            Int?            @default(0)
  user              User            @relation(fields: [userId], references: [id])
  educationalPath   EducationalPath @relation(fields: [educationalPathId], references: [id])

  @@unique([userId, educationalPathId], map: "UserEducationalPath_userId_educationalPathId_unique")
  @@index([educationalPathId])
  @@index([roleId])
  @@index([userId])
}

model UserModule {
  id         Int      @id @default(autoincrement())
  userId     Int
  moduleId   Int
  isOpen     Boolean  @default(false)
  isFinished Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module     Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([moduleId])
  @@index([userId])
}

model Wishlist {
  id      Int     @id @default(autoincrement())
  name    String?
  contact String?
}

enum PriceInterval {
  ONE_TIME
  MONTH
  YEAR
}

model PlatformFeeConfig {
  id                    Int     @id @default(autoincrement())
  name                  String  @unique
  description           String?
  individualMonthlyFee  Decimal @default(39) @db.Decimal(10, 2)
  schoolYearlyFee       Decimal @default(1499) @db.Decimal(10, 2)
  currency              String  @default("PLN")
  trialPeriodDays       Int     @default(30)
  isActive              Boolean @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("platform_fee_configs")
}

model TeacherPlatformSubscription {
  id                     Int      @id @default(autoincrement())
  userId                 Int      @unique
  subscriptionType       String   // "individual" or "school"
  paymentId              String?
  eventType              String?  @db.VarChar(100)
  amount                 Decimal? @db.Decimal(10, 2)
  currency               String?  @db.VarChar(10)
  paymentStatus          String?  @db.VarChar(50)
  paymentMethod          String?  @db.VarChar(100)
  subscriptionId         String?  @db.VarChar(255)
  isRecurring            Boolean  @default(true)
  subscriptionStatus     String?  @db.VarChar(50)
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  trialStart             DateTime?
  trialEnd               DateTime?
  customerEmail          String?  @db.VarChar(255)
  invoiceId              String?  @db.VarChar(255)
  receiptUrl             String?
  refundedAmount         Decimal? @db.Decimal(10, 2)
  refundReason           String?  @db.VarChar(255)
  metadata               Json?
  stripeCustomerId       String?  @db.VarChar(255)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([paymentId])
  @@index([customerEmail])
  @@map("teacher_platform_subscriptions")
}

model CourseCommunication {
  id          Int                    @id @default(autoincrement())
  courseId    Int
  platform    CommunicationPlatform
  link        String                 @db.VarChar(500)
  label       String?                @db.VarChar(100)
  description String?                @db.Text
  isActive    Boolean                @default(true)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  
  course      Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, platform, label])
  @@index([courseId])
  @@index([platform])
}

enum CommunicationPlatform {
  WHATSAPP
  TELEGRAM
  DISCORD
  SLACK
  TEAMS
  ZOOM
  CUSTOM
}

model NotificationSchedule {
  id            Int      @id @default(autoincrement())
  schoolId      Int
  title         String   @db.VarChar(255)
  message       String   @db.Text
  cronExpression String  @db.VarChar(100)
  isEnabled     Boolean  @default(true)
  notificationType String @db.VarChar(50) // 'newLesson', 'noActivity', 'payment', etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastSentAt    DateTime?
  
  school        School   @relation("SchoolNotifications", fields: [schoolId], references: [id], onDelete: Cascade)
  sentLogs      NotificationSentLog[]

  @@index([schoolId])
  @@index([isEnabled])
  @@index([cronExpression])
}

model NotificationSentLog {
  id                     Int                  @id @default(autoincrement())
  notificationScheduleId Int
  recipientEmail         String               @db.VarChar(255)
  recipientUserId        Int
  sentAt                 DateTime             @default(now())
  status                 NotificationStatus   @default(PENDING)
  errorMessage           String?              @db.Text
  
  notificationSchedule   NotificationSchedule @relation(fields: [notificationScheduleId], references: [id], onDelete: Cascade)
  recipient              User                 @relation("NotificationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([notificationScheduleId])
  @@index([recipientUserId])
  @@index([sentAt])
  @@index([status])
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}
